<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    #submitComments {
        position: relative;
        left: 50%;
        transform: translate(-50%, 0%);
    }
    body{
        color:#000;
    }
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 60px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
    #container{
        /*Styling for any element with the id="container" */
        width:1800px; /* The width is fixed by pixels */
        height:800px; /* The height is fixed by pixels*/
        color:black;
    }
</style>
<body>
<div id="container">
    <div id="instruction" style="text-align:center;">
        <h1 id="heading"></h1>

        <br> <br>
        <div id="table"></div>
    </div>
    <br>
    <div id="notation" style="text-align:left;">
        <!--<label id="page"></label>-->
    </div>
    <button id="submitComments" class="next-button" type="button">Ready to Answer Questions?</button><label id="answer_all" style="position: absolute; left: 150px; color: red;"></label><br>
</div>
<br>
</body>
</html>
<script src="javascript/misc/util.js"></script>
<script>//display 6 record in page
    (function(){
        $.getScript("javascript/misc/util.js");
        console.log(experimentr.data()["mat"]);
      //  experimentr.startTimer('main_section');
        experimentr.data()['section'] = 'mat';
        experimentr.hideNext();
        // pages

        var step = 0,
            sec_switch = 0;

        function delay_next(time){
            d3.select("#submitComments").attr("disabled","true");
            d3.select("#submitComments").style("color","#b3b3b3");
            setTimeout(function(){
                d3.select("#submitComments").attr("disabled",null);
                d3.select("#submitComments").style("color","black");
            },time);
        }

        delay_next(250);

        function add_mod_intros(img_address){
            var height = "550px",
                width = "1000px",
                x = "400px",
                y = "20px";

            d3.select("#notation").select(".image").remove();
            var svg = d3.select("#notation")
                .append("svg")
                .attr("class", "image")
                .attr("width", 1800)
                .attr("height", 600);
            svg.append("svg:image")
                .attr("xlink:href","/resources/module_intros/"+img_address)
                .attr("x",x)
                .attr("y",y)
                .attr("width",width)
                .attr("height",height);
            svg.append("rect")
                .attr("x", x)
                .attr("y", y)
                .attr("height", height)
                .attr("width", width)
                .style("stroke", "black")
                .style("fill", "none");
        }

        console.log(experimentr.data());
        add_mod_intros("recap_5.PNG");


        var mod_pages = [1,2,3,4,5];//key for which pages display recap slides


        function goToNext() {
            //delete experimentr.data()["mat"];
            experimentr.next();
        }
        var start = Date.now();
        var restore = {};
        function all_answered(){
            var prev = start;
            var answer = Object.keys(restore).length>0? restore:{};
            var text = [];
            d3.selectAll(".result").remove();
            start = Date.now();
            for(i in experimentr.data()["clicks"]){
                if(+experimentr.data()["clicks"][i][0]>+prev){
                    answer[+experimentr.data()["clicks"][i][1]-1] = Math.floor(+experimentr.data()["clicks"][i][2]/3);
                }
            }
            if(Object.keys(answer).length < d3.selectAll(".blocks")[0].length){
                restore = answer;
                return(false);
//                disable_submit();
            } else {
                restore = {};
                return(true);
//                enable_submit();
            }
        };
//
//        function disable_submit(){
//            d3.select("#submitAnswers").attr("disabled","true");
//            d3.select("#submitAnswers").style("color","#b3b3b3");
//        }
//
//        function enable_submit(){
//            d3.select("#submitAnswers").attr("disabled",null);
//            d3.select("#submitAnswers").style("color","black");
//        }

        var start = Date.now();
        var restore = {};
        function all_answered(){
            var prev = start;
            var answer = Object.keys(restore).length>0? restore:{};
            var text = [];
            d3.selectAll(".result").remove();
            start = Date.now();
            for(i in experimentr.data()["clicks"]){
                if(+experimentr.data()["clicks"][i][0]>+prev){
                    answer[+experimentr.data()["clicks"][i][1]-1] = Math.floor(+experimentr.data()["clicks"][i][2]/3);
                }
            }
            if(Object.keys(answer).length < d3.selectAll(".blocks")[0].length){
                restore = answer;
                return(false);
//                disable_submit();
            } else {
                restore = {};
                return(true);
//                enable_submit();
            }
        };

        var start = Date.now();
        var restore = {};

        function formatted_join(string_array){
            if(string_array.length === 1){
                return(string_array);
            }else if(string_array.length === 2){
                return(string_array.join(" and "));
            } else{
                let res = string_array.slice(0,string_array.length-1).join(", ");
                return(res+" and "+string_array[string_array.length-1]);
            }
        };
        var submit_click=0;
        function feedback(){
            var questions = [];
            var data_pairs = experimentr.data()["mat"][step-1];
            for(var i =0; i<data_pairs.length; i++){
                questions.push(data_pairs[i][0][0])
            }
            var prev = start;
            var answer = Object.keys(restore).length>0 ? restore:{};
            var text = [];
            d3.selectAll(".result").remove();
            start = Date.now();
            for(i in experimentr.data()["clicks"]){
                console.log(experimentr.data()['clicks'][i][0], prev);
                if(experimentr.data()['clicks'][i][0] < prev){
                    answer[experimentr.data()["clicks"][i][1]-1] = Math.floor(experimentr.data()["clicks"][i][2]/3);
                }
                console.log(+experimentr.data()['clicks'][i][0]>+prev);
            }

            console.log(+experimentr.data()['clicks'][i][0]);
            console.log(experimentr.data()['clicks'][i][0]);
            console.log(experimentr.data()['mat_answer']);
            console.log(answer);
            console.log(experimentr.data()["clicks"]);
            //console.log(Object.keys(answer).length, d3.selectAll(".blocks")[0].length);
            //console.log(experimentr.data()['practice_answer']);

            var score = 0;
            var wrong_ans = [];
            for(i in answer){
                if(i == 4){
                    if(experimentr.data()['mat_answer'][12]==answer[4]){//  original 13 's answer = user answer for question 5
                        console.log("answer 5 is", answer[4]);
                        score += 1;
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 5){
                    if(experimentr.data()['mat_answer'][13]==answer[5]){ // original 14 's answer = user answer for question 6
                        score += 1;
                        console.log("answer 6 is", answer[5]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 6){
                    if(experimentr.data()['mat_answer'][14]==answer[6]){ // original 15's answer = user answer for question 7
                        score += 1;
                        console.log("answer 7 is", answer[6]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                //Minimum Mode
                else if(i == 7){
                    if(experimentr.data()['mat_answer'][18]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 8){
                    if(experimentr.data()['mat_answer'][19]==answer[i]){
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 9){
                    if(experimentr.data()['mat_answer'][20]==answer[i]){
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 10){
                    if(experimentr.data()['mat_answer'][24]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 11){
                    if(experimentr.data()['mat_answer'][25]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 12){
                    if(experimentr.data()['mat_answer'][26]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }

                else if(i == 13){
                    if(experimentr.data()['mat_answer'][30]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 14){
                    if(experimentr.data()['mat_answer'][31]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }
                else if(i == 15){
                    if(experimentr.data()['mat_answer'][32]==answer[i]){ // original 19's answer = user answer for question 8
                        score += 1;
                        console.log("answer "+ (i+1) + " is", answer[i]);
                    }
                    else{
                        wrong_ans.push((+i + 1).toString());
                    }
                }

                else {
//                    if (experimentr.data()['mat_answer'][+i] == answer[i]) {
//                        score += 1;
//                    } else {
//                        wrong_ans.push((+i + 1).toString());
                   // }
                }
            }

            console.log("1.Wrong answers are:"+wrong_ans);

            var ans_ques = Object.keys(answer);
            var unaswered_ques = [];
            //console.log("wrong_ans",wrong_ans);
            //console.log("ans_ques",ans_ques);
            for(var i=0; i < questions.length;i++){
                if(ans_ques.indexOf((parseInt(questions[i])-1).toString())<0){
                    //console.log("q not answered");
                    unaswered_ques.push((questions[i]).toString());
                    wrong_ans.push((questions[i]).toString());
                }
            }

//
//                if(Object.keys(answer).length < d3.selectAll(".blocks")[0].length){
//                    text = ['You have to answer all the questions to proceed.'];
//                }
            var allRight_3= true;
            var allRight_4=true;
            var allRight_5= true;
            var allRight_6= true;
            if(wrong_ans.length > 0){

                //text.push("Good try." );
                if (experimentr.data()["mode"] == "Partial_Cell"){
                for(var i=0;i<wrong_ans.length;i++) {
                    if (wrong_ans[i]==27){
                        text.push("QUESTION "+wrong_ans[i]+": The records are females. It is very likely that a woman is married and changed her last name.");
                    }
                    else if(wrong_ans[i]==25){
                        text.push("QUESTION "+wrong_ans[i]+": It is likely that the pair are twin.");
                    }
                    else if(wrong_ans[i]==8||wrong_ans[i]==29){
                        allRight_3= false;
                        text.push("Please review QUESTION "+wrong_ans[i]+": The race is different, the dob is missing, the IDs are different with the names being common names. Likely that the people are different");
                    }
                    else if(wrong_ans[i]==9||wrong_ans[i]==30){
                        allRight_3= false;
                        text.push("Please review QUESTION "+wrong_ans[i]+": Notice the difference in age and the jr/sr post-fix. It's likely that they represent father and son.");
                    }
                    else if(wrong_ans[i]==10||wrong_ans[i]==28){
                        allRight_3= false;
                        text.push("Please review QUESTION "+wrong_ans[i]+": The ID is missing but the first name might be a nick name and pair probably represents the same person.");
                    }
                    else if(wrong_ans[i]==26){
                        text.push("QUESTION "+wrong_ans[i]+": The first and last names have been swapped and the id is missing but they have the same birthdays. Likely represent the same person ");
                    }
                }
                if( allRight_3==true){
                    text.push("Good job");
                }}
                else if(experimentr.data()["mode"] == "Opti1") {
                    for(var i=0;i<wrong_ans.length;i++) {
                        if(step==5){
                        if (wrong_ans[i]==13){
                            allRight_4=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": The records are females. It is very likely that a woman is married and changed her last name.");
                        }
                        else if(wrong_ans[i]==11){
                            allRight_4=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": It is likely that the pair are twin.");
                        }
//                        else if(wrong_ans[i]==29){
//                            text.push("QUESTION "+wrong_ans[i]+": The race is different, the dob is missing, the IDs are different with the names being common names. Likely that the people are different");
//                        }
//                        else if(wrong_ans[i]==30){
//                            text.push("QUESTION "+wrong_ans[i]+": Notice the difference in age and the jr/sr post-fix. It's likely that they represent father and son.");
//                        }
//                        else if(wrong_ans[i]==28){
//                            text.push("QUESTION "+wrong_ans[i]+": The ID is missing but the first name might be a nick name and pair probably represents the same person.");
//                        }
                        else if(wrong_ans[i]==12){
                            allRight_4=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": The first and last names have been swapped and the id is missing but they have the same birthdays. Likely represent the same person ");
                        }
                    }
                    else{
                            if (wrong_ans[i]==14){
                                allRight_6=false;
                                text.push("Please review QUESTION "+wrong_ans[i]+": Here are the values before encryption. ID is 1001030318 and 1999839173, DOB is 12/14/1990 for the non-missing. Sex is female for both records, and Race is W and B. Note that both the first and last names are common names (Erin Carroll). Do you still think the two records refer to the same person?");
                            }
                            else if(wrong_ans[i]==15){
                                allRight_6=false;
                                text.push("Please review QUESTION "+wrong_ans[i]+": Here are the values before encryption. ID is 1000279225 for the non-missing, first name and last name are swapped between the two records (MAMIE-CLARA and BAKER) and sex is female. Note that the name frequencies indicate rare names except a common last name, when used as first name is rare. Do you still think the two records refer to two different people?");
                            }
//                            else if(wrong_ans[i]==34){
//                                text.push("QUESTION "+wrong_ans[i]+": Here are the values before encryption. The two last names were MCELMORE and HOYLE, and both were Females. Note that the name frequencies indicate rare first name (ALMERTH) and that last name changes for women due to marriage are common. Do you still think the two records refer to two different people?");
//                            }
//                            else if(wrong_ans[i]==35){
//                                text.push("QUESTION "+wrong_ans[i]+": Here are the values before encryption. ID is 1000336293 and 1000063393, last name LESTER and LESTER JR, DOB 07/23/1956 and 05/25/1917, and both their sexes is Male. Note that the only common values are a common first name (JOHN), race (B), and sex. Do you still think the two records refer to the same person?");
//                            }
//                            else if(wrong_ans[i]==36){
//                                text.push("QUESTION "+wrong_ans[i]+": The first names shown to be different are Judith and Judy but after encryption the attributes are very different. Knowing their first names, do you still think the two records refer to two different people?");
//                            }
                            else if(wrong_ans[i]==16){
                                allRight_6=false;
                                text.push("Please review QUESTION "+wrong_ans[i]+": Here are the values before encryption. ID is X and Y (note that it is different only by 1 character), first names are ERIC and ERICA, with Eric being Male and Erica being Female. Do you think they might be twins? Do you still think the two records refer to the same person?");
                            }

                        }
                    }
                    if(step==5&&allRight_4==true){
                        text.push("Good job!");
                    }
                    if(step!=5&&allRight_6==true){
                        text.push("Good job!");
                    }
                        }

                else{//partial mode
                    for(var i=0;i<wrong_ans.length;i++) {
                        if (wrong_ans[i]==19||wrong_ans[i]==25){
                            allRight_5=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": The records have the same gender. It is very likely that a woman is married and changed her last name.");
                        }
                        else if(wrong_ans[i]==6||wrong_ans[i]==20||wrong_ans[i]==26){
                            allRight_5=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": It is likely that the pair are twin.");
                        }
                        else if(wrong_ans[i]==21||wrong_ans[i]==27){
                            allRight_5=false;
                            text.push("QUESTION "+wrong_ans[i]+": The race is different, the dob is missing, the IDs are different with the names being common names. Likely that the people are different");
                        }
                        else if(wrong_ans[i]==7||wrong_ans[i]==22||wrong_ans[i]==28){
                            allRight_5=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": Notice the difference in age and the jr/sr post-fix. It's likely that they represent father and son.");
                        }
                        else if(wrong_ans[i]==5||wrong_ans[i]==23||wrong_ans[i]==29){
                            allRight_5=false;
                            text.push("Please review QUESTION "+wrong_ans[i]+": The ID is missing but the first name might be a nick name and pair probably represents the same person.");
                        }
                        else if(wrong_ans[i]==24||wrong_ans[i]==30){
                            allRight_5=false;
                            text.push("QUESTION "+wrong_ans[i]+": The first and last names have been swapped and the id is missing but they have the same birthdays. Likely represent the same person ");
                        }
                    }
                if(allRight_5==true){
                        text.push("Good job!");
                }}

            }

            restore = answer;
            if(text.length==0){
                text = ['Good job! Please click "Next" button to proceed.'];
                d3.select("#submitComments").style("display","inline");
                d3.select("#submitAnswers").style("display","none");
//                    d3.select("#submitComments").attr("disabled",null);
//                    d3.select("#submitComments").style("color","black");
                return true;
                restore = {};
            }
            d3.selectAll(".result").remove();
            for(var i = 0; i < text.length; i++){
                d3.select("#notation")
                    .append("h4")
                    .attr("class","result")
                    .text(text[i]);
            }
            submit_click += 1;
            console.log("submit_click is ï¼š"+submit_click);
            if(submit_click% 2===0) {
                console.log("1.Wrong answers are:"+wrong_ans);
                wrong_ans.length=0;
                console.log("1.Wrong answers are:"+wrong_ans);
                console.log("loop in true");
                return true;
            } else {
                return false;
            }



            if(text[0] === 'Good job! Please click "Next" button to proceed.'){
                return true;
            } else {
                return false;
            }
        };

//        console.log(experimentr.data()["mat"]);
//        console.log("Hi");
        var mode_order = ["Opti1","Partial","Partial","Partial_Cell","Opti1","Opti1","Partial"];
        step=2;
        function render_content(){
            if(step==experimentr.data()["mat"].length-1){
                experimentr.endTimer('main_section');
                console.log("In main_section",step);
                grading();
                goToNext();
            }else {

                if (sec_switch == 1 && (mod_pages.indexOf(step) > -1)) {
                    d3.select("#heading").style("visibility","hidden");
                    console.log("Step is",step);
                    d3.select('#submitComments').style("left", "50%").property("innerHTML","Ready to Answer Questions?");
                    d3.selectAll(".blocks").remove();
                    d3.select("#notation").html("");
                    if(step!=4&&step!=3&&step!=5) {
                        add_mod_intros("recap_" + (step + 1) + ".PNG");
                    }
                    else if(step==3){
                        add_mod_intros("recap_" + 6 + ".PNG");
                    }
                    else if(step==5){
                        add_mod_intros("recap_" + 7 + ".PNG");
                    }
                    else{
                        add_mod_intros("recap_" + 4 + ".PNG");
                    }


                    delay_next(250);
                    sec_switch = 0
                } else {
//                    d3.select("#notation").text("Page " + (step + 1).toString() + "/" + (experimentr.data()['mat'].length - 1).toString());
                    d3.select("#notation").text("");
                    //console.log("Hi there is a notation");
                    d3.select('#submitComments').style("left", "35px").property("innerHTML","Submit");
                    setTimeout(function () {
                        d3.selectAll(".blocks").remove();
                        experimentr.data()["mode"] = mode_order[step - 1];
                        console.log(experimentr.data()["mode"]);
                        console.log(mode_order[step-1]);
                        if(step == 6) {
                            experimentr.data()["mode"] = "Opti1";
                            console.log(experimentr.data()["mode"]);
                            cwidth =  [60,200,45,225,200,45,175,60,60,80];
                        }
                        //pairs(experimentr.data()["mat"][step - 1], step - 1, experimentr.data()["mat"][step - 1].length, experimentr.data()["mode"]);
                        if(experimentr.data()["mode"] == "Partial"){
                            d3.select("#heading").style("visibility","visible");
                            document.getElementById("heading").innerHTML = "Masked Mode";
                            //changing the pair number
                            experimentr.data()["mat"][step - 1][0][0][0] = "5";
                            experimentr.data()["mat"][step - 1][0][1][0] = "5";
                            experimentr.data()["mat"][step - 1][1][0][0] = "6";
                            experimentr.data()["mat"][step - 1][1][1][0] = "6";
                            experimentr.data()["mat"][step - 1][2][0][0] = "7";
                            experimentr.data()["mat"][step - 1][2][1][0] = "7";
                            pairs(experimentr.data()["mat"][step - 1], step - 1, 3, experimentr.data()["mode"]);
                        }
                        else if(experimentr.data()["mode"] == "Partial_Cell"){
                            d3.select("#heading").style("visibility","visible");
                            document.getElementById("heading").innerHTML = "Minimum Mode";
                            experimentr.data()["mat"][step - 1][0][0][0] = "8";
                            experimentr.data()["mat"][step - 1][0][1][0] = "8";
                            experimentr.data()["mat"][step - 1][1][0][0] = "9";
                            experimentr.data()["mat"][step - 1][1][1][0] = "9";
                            experimentr.data()["mat"][step - 1][2][0][0] = "10";
                            experimentr.data()["mat"][step - 1][2][1][0] = "10";
                            pairs(experimentr.data()["mat"][step - 1], step - 1, 3, experimentr.data()["mode"]);
                        }
                        else if(step == 6){
                            d3.select("#heading").style("visibility","visible");
                            document.getElementById("heading").innerHTML = "Encrypted Mode";
                            for (i = 0; i < 3; i++) {
                                var pairNum = i + 14;
                                experimentr.data()["mat"][step - 1][i][0][0] = pairNum.toString();
                                experimentr.data()["mat"][step - 1][i][1][0] = pairNum.toString();
                            }
                            pairs(experimentr.data()["mat"][step - 1], step - 1, 3, experimentr.data()["mode"]);
                            console.log("step is", step);
                        }
                        else if(experimentr.data()["mode"] == "Opti1"){
                            d3.select("#heading").style("visibility","visible");
                            document.getElementById("heading").innerHTML = "Moderate Mode";
                            experimentr.data()["mat"][step - 1][0][0][0] = "11";
                            experimentr.data()["mat"][step - 1][0][1][0] = "11";
                            experimentr.data()["mat"][step - 1][1][0][0] = "12";
                            experimentr.data()["mat"][step - 1][1][1][0] = "12";
                            experimentr.data()["mat"][step - 1][2][0][0] = "13";
                            experimentr.data()["mat"][step - 1][2][1][0] = "13";

                            pairs(experimentr.data()["mat"][step - 1], step - 1, 3, experimentr.data()["mode"]);
                            console.log("step is", step);
                        }


                        if (experimentr.data()["mode"] == "Vanilla") {
                            d3.selectAll(".icon").remove();
                            d3.selectAll(".freq").remove();
                            d3.selectAll(".tip").remove();
                        }


                    }, 100);

                    delay_next(350);

                    step += 1;
                    sec_switch = 1;

                }
            }
        }

        d3.select('#submitComments')
            .on('click', function () {
                //console.log(experimentr.data());
                d3.select("#answer_all").text("");
                //d3.select("#heading").remove();
                d3.select('#submitComments').style("left","2.5%");
                //console.log((Date.now()-experimentr.data()["time_of_website_start"])/(1000*60));
                if(parse_url().testing === 'true'){
                    render_content();
                } else {
                    if(d3.selectAll(".blocks")[0].length > 0){//blocks in number of questions in a page
                        if(all_answered()){
                            if(feedback()){
                                render_content();
                            }
                        } else {
                            d3.select("#answer_all").text("Please answer all questions to proceed")
                        }
                    } else {
                        render_content();
                    }
                }

                // time elapse
                experimentr.data()['switch'].push(Date.now());
                experimentr.save();
            });


    }());
</script>